#!/bin/vbash
# VyOS Configuration for AGG-1 Router
# Role: Access Aggregation Router

# System configuration
set system host-name 'agg-1'
set system domain-name 'telco.lab'
set system time-zone 'UTC'

# Configure loopback interface (Router ID)
set interfaces loopback lo address '10.0.0.21/32'
set interfaces loopback lo description 'Router ID'

# Interface to PE-1
set interfaces ethernet eth0 address '10.1.10.2/30'
set interfaces ethernet eth0 description 'Link to PE-1'
set interfaces ethernet eth0 mtu '1500'

# Interface to CPE subnet
set interfaces ethernet eth1 address '10.10.1.1/24'
set interfaces ethernet eth1 description 'CPE Access Network'
set interfaces ethernet eth1 mtu '1500'

# OSPF Configuration
set protocols ospf area 1 network '10.0.0.21/32'
set protocols ospf area 1 network '10.1.10.0/30'
set protocols ospf area 1 network '10.10.1.0/24'
set protocols ospf router-id '10.0.0.21'
set protocols ospf log-adjacency-changes
set protocols ospf parameters router-id '10.0.0.21'

# OSPF interface tuning
set protocols ospf interface eth0 cost 50
set protocols ospf interface eth1 cost 100
set protocols ospf interface eth0 hello-interval 10
set protocols ospf interface eth1 hello-interval 30
set protocols ospf interface eth0 dead-interval 40
set protocols ospf interface eth1 dead-interval 120

# Static routes for CPE networks
set protocols static route 10.10.1.0/24 interface eth1

# QoS Configuration for Access
set traffic-policy shaper ACCESS-OUT bandwidth '100mbit'
set traffic-policy shaper ACCESS-OUT class 10 bandwidth '20%'
set traffic-policy shaper ACCESS-OUT class 10 description 'Voice Traffic'
set traffic-policy shaper ACCESS-OUT class 10 match VOICE ip dscp 'ef'
set traffic-policy shaper ACCESS-OUT class 10 priority 7
set traffic-policy shaper ACCESS-OUT class 10 queue-type 'priority'
set traffic-policy shaper ACCESS-OUT class 20 bandwidth '30%'
set traffic-policy shaper ACCESS-OUT class 20 description 'Video Traffic'
set traffic-policy shaper ACCESS-OUT class 20 match VIDEO ip dscp 'af41'
set traffic-policy shaper ACCESS-OUT class 20 priority 5
set traffic-policy shaper ACCESS-OUT class 30 bandwidth '50%'
set traffic-policy shaper ACCESS-OUT class 30 description 'Data Traffic'
set traffic-policy shaper ACCESS-OUT class 30 match DATA ip dscp 'af21'
set traffic-policy shaper ACCESS-OUT class 30 priority 3
set traffic-policy shaper ACCESS-OUT default bandwidth '100%'
set traffic-policy shaper ACCESS-OUT default priority 1

# Apply QoS to uplink
set interfaces ethernet eth0 traffic-policy out 'ACCESS-OUT'

# DHCP Server for CPE devices
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 default-router '10.10.1.1'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 dns-server '8.8.8.8'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 dns-server '8.8.4.4'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 domain-name 'cpe.telco.lab'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 lease '86400'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 range CPE-POOL start '10.10.1.10'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 range CPE-POOL stop '10.10.1.100'

# Static DHCP reservations for known CPE devices
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 static-mapping cpe-1 ip-address '10.10.1.10'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 static-mapping cpe-1 mac-address '00:50:56:01:01:01'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 static-mapping cpe-3 ip-address '10.10.1.11'
set service dhcp-server shared-network-name CPE-NETWORK subnet 10.10.1.0/24 static-mapping cpe-3 mac-address '00:50:56:01:01:03'

# Firewall rules for CPE access
set firewall name CPE-IN default-action 'accept'
set firewall name CPE-IN rule 10 action 'drop'
set firewall name CPE-IN rule 10 description 'Block inter-CPE communication'
set firewall name CPE-IN rule 10 destination address '10.10.1.0/24'
set firewall name CPE-IN rule 10 source address '10.10.1.0/24'
set firewall name CPE-IN rule 20 action 'accept'
set firewall name CPE-IN rule 20 description 'Allow to gateway'
set firewall name CPE-IN rule 20 destination address '10.10.1.1'

set interfaces ethernet eth1 firewall in name 'CPE-IN'

# Rate limiting for CPE devices
set traffic-policy limiter CPE-LIMIT bandwidth '10mbit'
set traffic-policy limiter CPE-LIMIT default bandwidth '10mbit'
set interfaces ethernet eth1 traffic-policy in 'CPE-LIMIT'

# Management and monitoring
set service ssh port '22'
set service ssh listen-address '10.0.0.21'
set system login user admin authentication plaintext-password 'vyos123'
set system login user admin level 'admin'

# SNMP for monitoring
set service snmp community 'telco-lab' authorization 'ro'
set service snmp community 'telco-lab' network '192.168.100.0/24'
set service snmp location 'AGG-1 Router - Telco Lab'
set service snmp contact 'lab-admin@telco.lab'

# Logging
set system syslog global facility all level 'info'
set system syslog host 192.168.100.10 facility all level 'info'

# NTP
set system ntp server 'pool.ntp.org'

# Save configuration
commit
save
