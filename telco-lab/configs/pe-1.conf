#!/bin/vbash
# VyOS Configuration for PE-1 Router
# Role: Provider Edge Router with MPLS L3VPN

# System configuration
set system host-name 'pe-1'
set system domain-name 'telco.lab'
set system time-zone 'UTC'

# Configure loopback interface (Router ID)
set interfaces loopback lo address '10.0.0.1/32'
set interfaces loopback lo description 'Router ID and MPLS LSR-ID'

# Interface to External Gateway
set interfaces ethernet eth0 address '10.1.0.2/30'
set interfaces ethernet eth0 description 'Link to External Gateway'
set interfaces ethernet eth0 mtu '1500'

# Interface to Core-1
set interfaces ethernet eth1 address '10.1.1.1/30'
set interfaces ethernet eth1 description 'Link to Core-1'
set interfaces ethernet eth1 mtu '9000'

# Interface to AGG-1
set interfaces ethernet eth2 address '10.1.10.1/30'
set interfaces ethernet eth2 description 'Link to AGG-1'
set interfaces ethernet eth2 mtu '1500'

# VRF Configuration for Customer A
set vrf name CUSTOMER-A table '100'
set vrf name CUSTOMER-A description 'Customer A VPN'
set interfaces ethernet eth3 vrf 'CUSTOMER-A'
set interfaces ethernet eth3 address '172.16.1.1/24'
set interfaces ethernet eth3 description 'Customer A CE Interface'

# VRF Configuration for Customer B
set vrf name CUSTOMER-B table '200'
set vrf name CUSTOMER-B description 'Customer B VPN'
set interfaces ethernet eth4 vrf 'CUSTOMER-B'
set interfaces ethernet eth4 address '172.17.1.1/24'
set interfaces ethernet eth4 description 'Customer B CE Interface'

# OSPF Configuration
set protocols ospf area 0 network '10.0.0.1/32'
set protocols ospf area 0 network '10.1.1.0/30'
set protocols ospf area 1 network '10.1.10.0/30'
set protocols ospf router-id '10.0.0.1'
set protocols ospf log-adjacency-changes
set protocols ospf parameters router-id '10.0.0.1'

# OSPF interface tuning
set protocols ospf interface eth1 cost 10
set protocols ospf interface eth2 cost 50
set protocols ospf interface eth1 hello-interval 1
set protocols ospf interface eth2 hello-interval 10
set protocols ospf interface eth1 dead-interval 4
set protocols ospf interface eth2 dead-interval 40

# MPLS Configuration
set protocols mpls interface eth1
set protocols mpls ldp router-id '10.0.0.1'
set protocols mpls ldp interface eth1

# BGP Configuration
set protocols bgp 65001 router-id '10.0.0.1'
set protocols bgp 65001 parameters log-neighbor-changes

# iBGP to Route Reflectors
set protocols bgp 65001 neighbor 10.0.0.11 remote-as '65001'
set protocols bgp 65001 neighbor 10.0.0.11 update-source 'loopback'
set protocols bgp 65001 neighbor 10.0.0.12 remote-as '65001'
set protocols bgp 65001 neighbor 10.0.0.12 update-source 'loopback'

# eBGP to External Gateway
set protocols bgp 65001 neighbor 10.1.0.1 remote-as '65000'
set protocols bgp 65001 neighbor 10.1.0.1 description 'External Gateway'

# BGP Address Families
set protocols bgp 65001 address-family ipv4-unicast network '10.0.0.1/32'
set protocols bgp 65001 address-family ipv4-labeled-unicast neighbor 10.0.0.11 activate
set protocols bgp 65001 address-family ipv4-labeled-unicast neighbor 10.0.0.12 activate

# VPN Address Families for Customer A
set protocols bgp 65001 address-family ipv4-vpn neighbor 10.0.0.11 activate
set protocols bgp 65001 address-family ipv4-vpn neighbor 10.0.0.12 activate

# VRF BGP Configuration for Customer A
set protocols bgp 65001 vrf CUSTOMER-A rd '65001:100'
set protocols bgp 65001 vrf CUSTOMER-A route-target export '100:100'
set protocols bgp 65001 vrf CUSTOMER-A route-target import '100:100'
set protocols bgp 65001 vrf CUSTOMER-A address-family ipv4-unicast network '172.16.1.0/24'
set protocols bgp 65001 vrf CUSTOMER-A neighbor 172.16.1.10 remote-as '65100'
set protocols bgp 65001 vrf CUSTOMER-A neighbor 172.16.1.10 description 'Customer A CE'

# VRF BGP Configuration for Customer B
set protocols bgp 65001 vrf CUSTOMER-B rd '65001:200'
set protocols bgp 65001 vrf CUSTOMER-B route-target export '200:200'
set protocols bgp 65001 vrf CUSTOMER-B route-target import '200:200'
set protocols bgp 65001 vrf CUSTOMER-B address-family ipv4-unicast network '172.17.1.0/24'
set protocols bgp 65001 vrf CUSTOMER-B neighbor 172.17.1.10 remote-as '65200'
set protocols bgp 65001 vrf CUSTOMER-B neighbor 172.17.1.10 description 'Customer B CE'

# Static routes for internet access
set protocols static route 0.0.0.0/0 next-hop 10.1.0.1

# QoS Configuration
set traffic-policy shaper PE-OUT bandwidth '1gbit'
set traffic-policy shaper PE-OUT class 10 bandwidth '20%'
set traffic-policy shaper PE-OUT class 10 description 'Voice Traffic'
set traffic-policy shaper PE-OUT class 10 match VOICE ip dscp 'ef'
set traffic-policy shaper PE-OUT class 10 priority 7
set traffic-policy shaper PE-OUT class 20 bandwidth '30%'
set traffic-policy shaper PE-OUT class 20 description 'Video Traffic'
set traffic-policy shaper PE-OUT class 20 match VIDEO ip dscp 'af41'
set traffic-policy shaper PE-OUT class 20 priority 5
set traffic-policy shaper PE-OUT class 30 bandwidth '50%'
set traffic-policy shaper PE-OUT class 30 description 'Data Traffic'
set traffic-policy shaper PE-OUT class 30 match DATA ip dscp 'af21'
set traffic-policy shaper PE-OUT default bandwidth '100%'
set traffic-policy shaper PE-OUT default priority 1

# Apply QoS policies
set interfaces ethernet eth0 traffic-policy out 'PE-OUT'
set interfaces ethernet eth1 traffic-policy out 'PE-OUT'
set interfaces ethernet eth2 traffic-policy out 'PE-OUT'

# Firewall configuration
set firewall name OUTSIDE-IN default-action 'drop'
set firewall name OUTSIDE-IN rule 10 action 'accept'
set firewall name OUTSIDE-IN rule 10 state established 'enable'
set firewall name OUTSIDE-IN rule 10 state related 'enable'
set firewall name OUTSIDE-IN rule 20 action 'accept'
set firewall name OUTSIDE-IN rule 20 protocol 'icmp'
set firewall name OUTSIDE-IN rule 30 action 'accept'
set firewall name OUTSIDE-IN rule 30 destination port '22,179,646'
set firewall name OUTSIDE-IN rule 30 protocol 'tcp'

set interfaces ethernet eth0 firewall in name 'OUTSIDE-IN'

# NAT for internet access
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 source address '10.0.0.0/8'
set nat source rule 100 translation address 'masquerade'

# Management and monitoring
set service ssh port '22'
set service ssh listen-address '10.0.0.1'
set system login user admin authentication plaintext-password 'vyos123'
set system login user admin level 'admin'

# SNMP for monitoring
set service snmp community 'telco-lab' authorization 'ro'
set service snmp community 'telco-lab' network '192.168.100.0/24'
set service snmp location 'PE-1 Router - Telco Lab'
set service snmp contact 'lab-admin@telco.lab'

# Logging
set system syslog global facility all level 'info'
set system syslog host 192.168.100.10 facility all level 'info'

# NTP
set system ntp server 'pool.ntp.org'

# Save configuration
commit
save
